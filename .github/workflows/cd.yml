name: Deployment

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
    branches: [main]

concurrency:
  group: production-deployment
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: production
    if: |
      github.event.workflow_run.conclusion == 'success' &&
      github.event.workflow_run.event == 'push'
    
    steps:
    - uses: actions/checkout@v4
      with:
        ref: ${{ github.event.workflow_run.head_sha }}

    - name: Deploy to Render
      id: deploy
      uses: johnbeynon/render-deploy-action@v0.0.8
      with:
        service-id: ${{ secrets.RENDER_SERVICE_ID }}
        api-key: ${{ secrets.RENDER_API_KEY }}

    - name: Deployment Result
      if: always()
      run: |
        if [ "${{ steps.deploy.outcome }}" == "success" ]; then
          echo "‚úÖ Deployment triggered successfully"
          echo "üîó Verify at: https://fastapi-analytics-project.onrender.com/docs"
        else
          echo "‚ùå Deployment failed"
          exit 1
        fi
